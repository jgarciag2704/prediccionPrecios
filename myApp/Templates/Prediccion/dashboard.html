{% extends 'layouts/base.html' %}
{% load static %}
{% block content %}
<br>
<br>
<div class="container mt-5">
    <div class="card shadow-lg p-4">
        <h1 class="text-center mb-4">{{ title }}</h1>
        <form method="POST">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-3">
                    <label for="nombreSelect">Selecciona un producto:</label>
                    <select id="nombreSelect" name="nombre" class="form-control" onchange="this.form.submit()">
                        <option value="">-- Selecciona --</option>
                        {% for nombre in nombres %}
                            <option value="{{ nombre }}" {% if nombre == request.POST.nombre %}selected{% endif %}>
                                {{ nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="fecha_inicio">Desde:</label>
                    <input type="date" id="fecha_inicio" name="fecha_inicio" class="form-control"
                           value="{{ request.POST.fecha_inicio }}">
                </div>
                <div class="col-md-2">
                    <label for="fecha_fin">Hasta:</label>
                    <input type="date" id="fecha_fin" name="fecha_fin" class="form-control"
                           value="{{ request.POST.fecha_fin }}">
                </div>
                <div class="col-md-3">
                    <label for="modeloSelect">Selecciona un modelo:</label>
                    <select id="modeloSelect" name="modelo" class="form-control">
                        <option value="prophet" {% if request.POST.modelo == "prophet" %}selected{% endif %}>Prophet</option>
                        <option value="random_forest" {% if request.POST.modelo == "random_forest" %}selected{% endif %}>Random Forest</option>
                        <option value="lstm" {% if request.POST.modelo == "lstm" %}selected{% endif %}>LSTM</option>
                        <option value="xgboost" {% if request.POST.modelo == "xgboost" %}selected{% endif %}>XGBoost</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                </div>
            </div>
        </form>
        <div class="mt-3">
            <p><strong>Presentación:</strong> {{ presentacion }}</p>
            <p><strong>Mercado:</strong> {{ mercado }}</p>
            <p><strong>Días de cosecha en Verano:</strong> {{ tiempoCosechaVerano }} días</p>
            <p><strong>Días de cosecha en Invierno:</strong> {{ tiempoCosechaInvierno }} días</p>
        </div>
    </div>
</div>

<!-- Mostrar las mejores fechas de plantación -->
<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            <div class="alert alert-info text-center">
                <h5>Mejor fecha para plantar en <strong>Verano</strong></h5>
                <p>{{ mejor_plantacion_verano }}</p>
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-primary text-center">
                <h5>Mejor fecha para plantar en <strong>Invierno</strong></h5>
                <p>{{ mejor_plantacion_invierno }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Mostrar métricas de evaluación -->
<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            <div class="alert alert-success text-center">
                <h5>Error Cuadrático Medio (MSE)</h5>
                <p>{{ mse|floatformat:2 }}</p>
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-warning text-center">
                <h5>Error Absoluto Medio (MAE)</h5>
                <p>{{ mae|floatformat:2 }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Sección del gráfico -->
<div class="container-fluid mt-4">
    <figure class="highcharts-figure">
        <div id="container" style="height: 500px;"></div>
    </figure>
</div>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>

<script id="data-precios" type="application/json">{{ precios|safe }}</script>
<script id="data-predicciones" type="application/json">{{ predicciones|safe }}</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    if (!Highcharts.Series.types.arearange) {
        let script = document.createElement('script');
        script.src = "https://code.highcharts.com/highcharts-more.js";
        document.head.appendChild(script);
        script.onload = iniciarGrafico;
    } else {
        iniciarGrafico();
    }
});

function iniciarGrafico() {
    let precios = JSON.parse(document.getElementById("data-precios").textContent);
    let predicciones = JSON.parse(document.getElementById("data-predicciones").textContent);

    let dataSeries = precios.map(item => [Date.parse(item.fecha), item.precioPromedio]);
    let prediccionSeries = predicciones.map(item => [Date.parse(item.fecha), item.precio]);
    let intervaloInferior = predicciones.map(item => [Date.parse(item.fecha), item.min_95]);
    let intervaloSuperior = predicciones.map(item => [Date.parse(item.fecha), item.max_95]);

    if (dataSeries.length > 0 && prediccionSeries.length > 0) {
        let ultimaFecha = dataSeries[dataSeries.length - 1][0];
        let ultimoPrecio = dataSeries[dataSeries.length - 1][1];
        prediccionSeries.unshift([ultimaFecha, ultimoPrecio]);
        intervaloInferior.unshift([ultimaFecha, ultimoPrecio]);
        intervaloSuperior.unshift([ultimaFecha, ultimoPrecio]);
    }

    Highcharts.chart('container', {
        chart: { type: 'spline' },
        title: { text: 'Histórico de Precios y Predicción con Intervalo de Confianza' },
        xAxis: { type: 'datetime' },
        yAxis: { title: { text: 'Precio Promedio' }},
        series: [
            {
                name: "Precio Promedio Histórico",
                data: dataSeries,
                color: 'blue'
            },
            {
                name: "Predicción",
                data: prediccionSeries,
                color: 'green',
                dashStyle: 'ShortDash',
                marker: { enabled: false }
            },
            {
                name: "Intervalo de Confianza (90%)",
                type: 'arearange',
                data: intervaloInferior.map((item, i) => [item[0], intervaloInferior[i][1], intervaloSuperior[i][1]]),
                color: 'rgba(0, 128, 0, 0.2)',
                enableMouseTracking: false
            }
        ]
    });
}
</script>
{% endblock %}