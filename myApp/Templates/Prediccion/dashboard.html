{% extends 'layouts/base.html' %}
{% load static %}
{% block content %}
    <h1>{{ title }}</h1>
    <form method="POST">
        {% csrf_token %}
        <label for="nombreSelect">Selecciona un producto:</label>
        <select id="nombreSelect" name="nombre" onchange="this.form.submit()">
            <option value="">-- Selecciona --</option>
            {% for nombre in nombres %}
                <option value="{{ nombre }}" {% if nombre == request.POST.nombre %}selected{% endif %}>{{ nombre }}</option>
            {% endfor %}
        </select>
        <label for="fecha_inicio">Desde:</label>
    <input type="date" id="fecha_inicio" name="fecha_inicio" value="{{ request.POST.fecha_inicio }}">

    <label for="fecha_fin">Hasta:</label>
    <input type="date" id="fecha_fin" name="fecha_fin" value="{{ request.POST.fecha_fin }}">

    <button type="submit">Filtrar</button>

    </form>
    <p id="presentacionLabel"><strong>Presentaci贸n:</strong> {{ presentacion }}</p>
    <p id="mercadoLabel"><strong>Presentaci贸n:</strong> {{ mercado }}</p>

    <script src="https://code.highcharts.com/highcharts.js"></script>

    <figure class="highcharts-figure">
        <div id="container"></div>
    </figure>

    <!-- Guardamos precios en un script seguro -->
    <script id="data-precios" type="application/json">{{ precios|safe }}</script>
    <script id="data-predicciones" type="application/json">{{ predicciones|safe }}</script>
    <script>
document.addEventListener("DOMContentLoaded", function() {
    let precios = JSON.parse(document.getElementById("data-precios").textContent);
    let predicciones = JSON.parse(document.getElementById("data-predicciones").textContent);

    let dataSeries = precios.map(item => [Date.parse(item.fecha), item.precioPromedio]);
    let prediccionSeries = predicciones.map(item => [Date.parse(item.fecha), item.precio]);

    if (dataSeries.length > 0 && prediccionSeries.length > 0) {
        let ultimaFecha = dataSeries[dataSeries.length - 1][0];
        prediccionSeries.unshift([ultimaFecha, dataSeries[dataSeries.length - 1][1]]);
    }

    Highcharts.chart('container', {
        chart: { type: 'spline' },
        title: { text: 'Hist贸rico de Precios y Predicciones Futuras' },
        xAxis: { type: 'datetime' },
        yAxis: { title: { text: 'Precio Promedio' }},
        series: [{
            name: "Precio Promedio Hist贸rico",
            data: dataSeries,
            color: 'blue'
        }, {
            name: "Predicciones Futuras",
            data: prediccionSeries,
            dashStyle: 'ShortDash',
            color: 'red'
        }]
    });
});
</script>



{% endblock %}
